# 考勤计算器 - 需求文档

## 项目概述

根据公司弹性打卡制度，开发一个 Web 应用，帮助员工计算在满足本周工时要求的前提下，当天最早的下班时间。

---

## 公司考勤制度

### 1. 弹性打卡制度

**基本规则**：
- 每天标准工时：**8 小时**
- 弹性上班时间：**8:00 - 9:30**
- 对应下班时间：**18:00 - 19:30**
- 每天固定午休：**12:00 - 14:00**（2 小时）

**说明**：
- 早上打卡最早为 8:00
- 如果 8:00 之前打卡，有效工作时间从 8:00 开始计算
- 例如：7:50 打卡，8:00 才开始计工时

### 2. 工时累加规则

**核心规则**：
- 本周内之前每天超出 8 小时的部分，按分钟计算可以累加到本周后面的工时中
- 累加的工时可以减少后续天数的工作时长

**示例**：
- 周一：8:00 上班，19:00 下班
  - 实际工作：11 小时（扣除午休）
  - 超出标准：3 小时
- 周二：9:00 上班
  - 正常需要工作到 18:00（9:00 + 8h + 午休）
  - 因为周一超出 3 小时
  - 周二只需工作 5 小时即可
  - 可以在 16:00 下班（9:00 + 5h + 午休）

### 3. 已申请加班规则

**重要**：
- 员工可以输入**已申请的加班时长**
- 已申请的加班时长**必须从当天工时中扣除**
- 因为已申请加班（可能单独计算或带薪），不计入 8 小时正常工时

**计算公式**：
```
当天有效工时 = (下班时间 - 上班时间 - 午休时间) - 已申请加班时长
```

**示例**：
- 上班：8:49
- 下班：19:22
- 午休扣除：2 小时
- 已申请加班：1 小时
- **有效工时 = 19:22 - 8:49 - 2h - 1h = 7.55 小时**

---

## 功能需求

### 输入功能

1. **本周工作天数**
   - 用户输入本周计划工作的天数
   - 本周要求总工时 = 工作天数 × 8 小时

2. **每日打卡时间**
   - 逐日输入上下班打卡时间
   - 支持输入已申请的加班时长（小时）
   - 未下班的日期不参与计算

3. **批量导入**
   - 支持 CSV 文件导入
   - 支持 Excel 文件导入
   - 支持钉钉打卡记录格式
   - 支持企业微信打卡记录格式

### 输出功能

1. **本周统计**
   - 前 N 天总有效工时（N = 已下班的天数）
   - 本周要求总工时（工作天数 × 8）
   - 还差多少工时

2. **当天建议**
   - 今天还需要工作多少小时
   - 今天最早下班时间

3. **历史记录**
   - 保存每周的记录
   - 可以查看历史周数据

### 数据存储

- **本地存储**：使用浏览器 IndexedDB
- **隐私保护**：所有数据仅存在本地，不上传服务器
- **数据导出**：支持导出为 JSON/CSV

---

## 计算示例（用户提供）

### 输入数据

**本周工作天数**：6 天

**每日打卡时间**：

| 日期 | 星期 | 上班 | 下班 | 已申请加班 |
|------|------|------|------|------------|
| 2月9日 | 周一 | 8:49 | 19:22 | - |
| 2月10日 | 周二 | 8:59 | 16:55 | - |
| 2月11日 | 周三 | 9:02 | 17:04 | - |
| 2月12日 | 周四 | 9:00 | 17:36 | - |
| 2月13日 | 周五 | 9:06 | 16:31 | - |
| 2月14日 | 周六 | 8:49 | ? | - |

### 计算过程

#### 单日工时计算

**公式**：
```
有效工时 = (下班时间 - 上班时间) - 午休时间(2h) - 已申请加班时长
```

**周一 (2月9日)**：
- 上班：8:49 → 有效开始：8:49（在 8:00-9:30 之间）
- 下班：19:22
- 工作时长：19:22 - 8:49 = 10小时33分
- 扣除午休：10h33m - 2h = **8小时33分** (8.55小时)

**周二 (2月10日)**：
- 上班：8:59 → 有效开始：8:59
- 下班：16:55
- 工作时长：16:55 - 8:59 = 7小时56分
- 扣除午休：7h56m - 2h = **5小时56分** (5.93小时)

**周三 (2月11日)**：
- 上班：9:02 → 有效开始：9:02（晚于 9:30，按实际时间）
- 下班：17:04
- 工作时长：17:04 - 9:02 = 8小时02分
- 扣除午休：8h02m - 2h = **6小时02分** (6.03小时)

**周四 (2月12日)**：
- 上班：9:00 → 有效开始：9:00
- 下班：17:36
- 工作时长：17:36 - 9:00 = 8小时36分
- 扣除午休：8h36m - 2h = **6小时36分** (6.60小时)

**周五 (2月13日)**：
- 上班：9:06 → 有效开始：9:06
- 下班：16:31
- 工作时长：16:31 - 9:06 = 7小时25分
- 扣除午休：7h25m - 2h = **5小时25分** (5.42小时)

#### 本周统计

```
前 5 天总有效工时：
  8h33m + 5h56m + 6h02m + 6h36m + 5h25m
= 8.55 + 5.93 + 6.03 + 6.60 + 5.42
= 32.53 小时
= 32 小时 32 分钟
```

**本周要求**：
```
6 天 × 8 小时 = 48 小时
```

**还差工时**：
```
48:00 - 32:32 = 15 小时 28 分钟
```

### 输出结果

**今天 (2月14日，周六)**：
- 上班时间：8:49
- 还需工时：15h28m
- **今天需要的工时：7小时28分钟**（最多工作 8 小时）
- 计算下班时间：
  - 从 8:49 开始工作 7h28m
  - 8:49 + 7h28m = 16:17
  - 加上 2 小时午休（假设跨越午休）
  - **下班时间：18:17**

**结论**：你今天 **18:17** 下班，就刚好满足本周 40 小时工时要求。

> **注意**：用户提供示例中说"本周要求：40小时"，可能是指 5 天工作制。实际计算时应按用户输入的工作天数来计算要求工时。

---

## 核心计算逻辑

### 1. 单日有效工时计算

```typescript
function calculateDailyHours(
  checkIn: string,      // "08:49"
  checkOut: string,     // "19:22"
  appliedOvertime: number, // 已申请加班时长（小时）
  config: SystemConfig
): number {
  // 1. 转换为分钟数
  const inMinutes = timeToMinutes(checkIn);
  const outMinutes = timeToMinutes(checkOut);

  // 2. 确定有效开始时间
  // - 如果上班时间早于 8:00，按 8:00 计算
  // - 如果上班时间在 8:00-9:30 之间，按实际时间计算
  // - 如果上班时间晚于 9:30，按实际时间计算
  const flexibleStartEarly = timeToMinutes(config.flexibleStartEarly);
  const effectiveStart = Math.max(inMinutes, flexibleStartEarly);

  // 3. 计算工作时长（分钟）
  let workMinutes = outMinutes - effectiveStart;

  // 4. 扣除午休（如果跨越 12:00-14:00）
  const lunchStart = timeToMinutes(config.lunchStart);
  const lunchEnd = timeToMinutes(config.lunchEnd);

  if (inMinutes < lunchEnd && outMinutes > lunchStart) {
    // 工作时间跨越午休，需要扣除
    const overlapStart = Math.max(inMinutes, lunchStart);
    const overlapEnd = Math.min(outMinutes, lunchEnd);
    workMinutes -= (overlapEnd - overlapStart);
  }

  // 5. 扣除已申请的加班时长
  const appliedOvertimeMinutes = appliedOvertime * 60;
  workMinutes -= appliedOvertimeMinutes;

  // 6. 转换为小时
  return Math.round((workMinutes / 60) * 100) / 100;
}
```

### 2. 本周累计工时计算

```typescript
function calculateWeeklyHours(records: WorkRecord[]): number {
  return records.reduce((total, record) => {
    if (!record.checkOutTime) return total; // 未下班，不计入
    return total + (record.effectiveHours || 0);
  }, 0);
}
```

### 3. 最早下班时间计算

```typescript
function calculateEarlyOffTime(
  checkInTime: string,        // "08:49"
  remainingRequiredHours: number, // 本周剩余需要的工时
  config: SystemConfig
): string {
  // 1. 计算今天需要的工时（最多 8 小时）
  const todayRequired = Math.min(remainingRequiredHours, config.standardWorkHours);

  // 2. 转换为分钟
  const todayRequiredMinutes = todayRequired * 60;

  // 3. 从上班时间开始计算
  const checkInMinutes = timeToMinutes(checkInTime);
  let offMinutes = checkInMinutes + todayRequiredMinutes;

  // 4. 加上午休时间（如果跨越午休）
  const lunchStart = timeToMinutes(config.lunchStart);
  const lunchEnd = timeToMinutes(config.lunchEnd);

  if (checkInMinutes < lunchEnd && offMinutes > lunchStart) {
    offMinutes += (lunchEnd - lunchStart);
  }

  // 5. 转换为时间字符串
  return minutesToTime(offMinutes);
}
```

---

## 边界情况处理

### 1. 时间异常

- **上班时间早于 8:00**：按 8:00 计算
- **上班时间晚于 9:30**：按实际时间计算，但可能不符合公司规定
- **下班时间早于上班时间**：提示错误
- **下班时间未输入**：该天不计入总工时

### 2. 午休处理

- **上班时间在午休后（14:00 之后）**：不扣除午休
- **下班时间在午休前（12:00 之前）**：不扣除午休
- **完全在午休期间**：提示错误
- **跨越午休**：自动扣除 2 小时

### 3. 已申请加班

- **已申请加班时长 > 当天工作时间**：提示错误
- **未填写已申请加班**：默认为 0

### 4. 工时异常

- **单日工时 < 4 小时**：提示可能数据错误
- **单日工时 > 12 小时**：提示可能数据错误
- **本周累计工时 > 要求工时 + 16 小时**：提示可能数据错误（每天最多加班 2 小时）

---

## UI/UX 要求

### 主界面布局

```
┌─────────────────────────────────────────────────┐
│  考勤计算器                        [设置] [历史] │
├─────────────────────────────────────────────────┤
│  周: 2026-02-09 ~ 2026-02-15  [<] [>]        │
│  本周工作天数: [6]                              │
├─────────────────────────────────────────────────┤
│  本周统计                                     │
│  ┌─────────────────────────────────────────┐   │
│  │  已工作: 5 天  总工时: 32h32m           │   │
│  │  要求工时: 48h (6天 × 8h)               │   │
│  │  还需工时: 15h28m                       │   │
│  │  ───────────────────────────────        │   │
│  │  今天上班: 08:49                       │   │
│  │  最早下班: 18:17 (需工作 7h28m)       │   │
│  └─────────────────────────────────────────┘   │
├─────────────────────────────────────────────────┤
│  工作日记录                     [+ 添加] [导入] │
│  ┌─────────────────────────────────────────┐   │
│  │ 周一 (02-09)  08:49 - 19:22  8.53h   │   │
│  │ 周二 (02-10)  08:59 - 16:55  5.93h   │   │
│  │ 周三 (02-11)  09:02 - 17:04  6.03h   │   │
│  │ 周四 (02-12)  09:00 - 17:36  6.60h   │   │
│  │ 周五 (02-13)  09:06 - 16:31  5.42h   │   │
│  │ 周六 (02-14)  08:49 - ??:??  -       │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 交互设计要点

1. **实时计算**
   - 修改任何时间输入，立即重新计算所有结果
   - 使用防抖优化，避免频繁计算

2. **智能提示**
   - 自动推断下班时间（基于标准工时）
   - 异常数据高亮提示

3. **输入便捷性**
   - 时间输入使用专门的时间选择器
   - 支持"现在"按钮快速填入当前时间
   - 支持 Tab 键快速切换输入框

4. **数据可视化**
   - 工时进度条展示（已完成 / 总要求）
   - 周趋势图表（每日工时曲线）

---

## 技术实现

### 技术栈

- **前端框架**：React 18 + TypeScript
- **构建工具**：Vite
- **UI 组件库**：Ant Design 5.x
- **状态管理**：Zustand
- **数据存储**：IndexedDB (Dexie.js)
- **时间处理**：Day.js
- **文件导入**：SheetJS (Excel), PapaParse (CSV)

### 部署方案

- **推荐**：静态部署到 GitHub Pages / Netlify / Vercel（免费）
- **可选**：打包为 Electron 桌面应用
- **可选**：PWA 支持（离线使用）

---

## 待确认事项

1. ✅ **已申请加班规则**：已确认，需要从工时中扣除
2. ❓ **工作日计算**：
   - 本周工作天数是用户手动输入，还是自动计算已下班的日期？
   - 假设是用户手动输入，本周要求工时 = 输入的工作天数 × 8
3. ❓ **周末工作**：
   - 周末工作是否计入本周工时？
   - 假设计入，但不限制必须是周一到周五
4. ❓ **跨周工时**：
   - 本周未用完的工时能否累积到下周？
   - 假设不能，每周独立计算

---

## 版本历史

### v1.0.0 (2026-02-14)
**类型**: 重大更新

**新增功能**:
- 弹性工时计算（上班 8:00-9:30，下班 18:00-19:30）
- 工时累加功能（本周超出的工时可累加到后续天数）
- 午休自动扣除（12:00-14:00，2小时）
- 支持输入已申请加班时长
- 日期范围筛选功能（最多7天）
- 假期同步功能（获取法定节假日数据）
- 假期日历显示（淡绿色标记节假日，浅绿色标记周末）
- 版本更新日志功能
- 数据保存到 IndexedDB
- 导出考勤记录为 PNG 图片

**UI优化**:
- 实时计算工时和下班时间
- 工时进度条展示
- 自动提示异常数据
- 日期范围选择器
- 假期日历显示

**规则限制**:
- 上班时间最早 8:00（自动调整）
- 下班时间最早 18:00
- 下班时间必须晚于上班时间
- 日期范围筛选最多7天
